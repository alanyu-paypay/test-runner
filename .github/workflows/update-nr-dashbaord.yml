name: update-nr-dashboard
on:
  workflow_dispatch:
    inputs:
      releaseBranch:
        required: true
        type: string
  pull_request:
    types:
      - closed
    branches:
      - 'release/**'

jobs:
  get_changed_endpoints_info:
    runs-on: ubuntu-latest
    outputs:
      fileName: ${{ steps.get-changed-endpoints-info.outputs.fileName }}
      releaseVersion: ${{ steps.get-changed-endpoints-info.outputs.releaseVersion }}
    steps:
      - name: Get changed endpoints info
        id: get-changed-endpoints-info
        run: |
          version=$(echo ${{ inputs.releaseBranch }} | grep -oP '[0-9]+\.[0-9]+\.[0-9]+')
          if [ -n "$version" ]; then
            echo "Release version is: $version"
            echo "File name is: Changed-Endpoints-$version.md"
            echo "releaseVersion=$version" >> "GITHUB_OUTPUT"
            echo "fileName=Changed-Endpoints-$version.md" >> "$GITHUB_OUTPUT"
            cat 
          else
            echo "Parsed fail"
            exit 1
          fi
  create_dashboard:
    runs-on: ubuntu-latest
    needs: get_changed_endpoints_info
    steps:
      - name: Get Release wiki
        uses: actions/checkout@v4
        with:
          repository: ${{github.repository}}.wiki
          sparse-checkout: |
            ${{ needs.get_changed_endpoints_info.outputs.fileName }}
          sparse-checkout-cone-mode: false
          path: wiki
      - name: Check file
        run: |
          file=${{ needs.get_changed_endpoints_info.outputs.fileName }}
          if [ ! -e "wiki/$file" ]; then
            echo "$file doesn't exist."
          fi

      - name: Get NR tools
        uses: actions/checkout@v4
        with:
          repository: Pay-Baymax/bff-tools
          ref: master
          path: tool
          token: ${{ secrets.PERSONAL_PAT }}
      - name: Update dashboard config file
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const readline = require('readline');
            const fileName = `${{ needs.get_changed_endpoints_info.outputs.fileName }}`;
            const version = `${{ needs.get_changed_endpoints_info.outputs.releaseVersion }}`;
            
            // Read the JSON file
            const data = fs.readFileSync('tool/new-relic/dashboard-generator/config/bff-release-ci.json', 'utf8');
            const config = JSON.parse(data);              
            
            // Set dashboard title
            config.title = `BFF Release ${version} - Changed Endpoints`;
            
            // Set changed endpoints
            let endpoints = config.endpoints;
            endpoints.push(`"## ${version} APIs`)
            fs.readFile(`wiki\\${fileName}`, 'utf8', (err, content) => {
              if (err) {
                core.error('Error reading config file:', err);
                core.setFailed(err);
              }
            
              // Parse the JSON data
              content.split(/\r?\n/).forEach(line => {
                if(line.length > 0) {
                  endpoints.push(line);
                }});
            });

            // Write to file
            fs.writeFileSync('tool/new-relic/dashboard-generator/config/bff-release-ci.json', JSON.stringify(config, null, 2), 'utf8');
      - name: Check config file
        run: cat tool/new-relic/dashboard-generator/config/bff-release-ci.json
