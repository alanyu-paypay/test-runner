# This is a basic workflow to help you get started with Actions

name: release-changed-endpoints

# Controls when the workflow will run
on:
  pull_request_target:
    types:
      - closed
    branches:
      - 'release/**'

jobs:
  get_changed_endpoints:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      endpoints: ${{ steps.extract-text.outputs.endpoints }}
    steps:
      - name: Get changed endpoints from PR
        run: |
          echo "PR Description: ${{ github.event.pull_request.body }}"
      - name: Extract Text from PR Description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        id: extract-text
        run: |
          changed_endpoints=$(echo "$PR_BODY" | awk '/## Changed Endpoints/{p=1; next} p && !/^##/ && NF{print}')
          if [ -n "$changed_endpoints" ]; then
            echo "Changed endpoints are:"
            echo "$changed_endpoints"
            echo "endpoints<<EOF" >> "$GITHUB_OUTPUT"
            echo "$changed_endpoints" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "No changed endpoints"
          fi
        shell: bash
  update_wiki:
    runs-on: ubuntu-latest
    needs: get_changed_endpoints
    if: ${{needs.get_changed_endpoints.outputs.endpoints}} != ""
    steps:
      - name: Checkout wiki
        uses: actions/checkout@v2
        with:
          repository: ${{github.repository}}.wiki
      - name: Create changed endpoints wiki
        id: tagName
        uses: actions/github-script@v6
        with:
          script: |
            const filePrefix = 'Changed Endpoints ';
            let endpoints = new Set<string>();
      - name: Commit wiki to git
        run: |
          git add .
          git config --global user.name 'CI bot'
          git config --global user.email 'paypay-bff@users.noreply.github.com'
          git commit -m "updated releasae wiki"
          git push
